<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>CBME × EPA 核心能力雷達圖</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind：只是為了好看一點的排版 -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js：用來畫雷達圖，比 Recharts 容易用 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-slate-50">
    <div class="min-h-screen p-4 md:p-8 text-slate-800">
      <div class="max-w-6xl mx-auto mb-6 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
        <h1 class="text-2xl md:text-3xl font-bold text-slate-900 mb-2">
          CBME 概念導航：11項公版 EPA × SIRIPPP 核心能力雷達圖
        </h1>
        <p class="text-sm text-slate-600">
          勾選右側任務，可<strong>疊加顯示</strong>不同 EPA 對七大核心能力（SIRIPPP）的需求強度，用於教學說明與比較。
        </p>
      </div>

      <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- 左側：雷達圖 -->
        <div
          class="lg:col-span-8 bg-white p-4 rounded-xl shadow-lg border border-slate-200 flex flex-col"
        >
          <div class="flex justify-between items-center mb-2">
            <h2 class="font-bold text-slate-700">能力雷達視圖（Radar Chart）</h2>
            <span id="selected-count" class="text-xs text-slate-400"></span>
          </div>
          <div class="w-full h-[420px] md:h-[500px]">
            <canvas id="epaRadarChart"></canvas>
          </div>
        </div>

        <!-- 右側：EPA 清單 + 說明 -->
        <div class="lg:col-span-4 flex flex-col gap-4">
          <!-- EPA 選單 -->
          <div
            class="bg-white p-4 rounded-xl shadow-md border border-slate-200 max-h-[520px] overflow-y-auto"
          >
            <h3 class="font-bold text-slate-800 mb-3 text-sm">
              EPA 任務清單（可複選）
            </h3>
            <div id="epa-list" class="space-y-2 text-sm"></div>
          </div>

          <!-- SIRIPPP 說明 -->
          <div class="bg-slate-800 text-white p-4 rounded-xl shadow-md text-xs">
            <div class="font-bold text-slate-300 mb-2">
              SIRIPPP 七大核心能力（地圖上的主幹道）
            </div>
            <ul id="sirippp-list" class="space-y-1"></ul>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 七大核心能力 (SIRIPPP)
      const competencies = [
        { subject: "S: Systems (制度體系)", full: "Systems-based Practice" },
        { subject: "I: Interpersonal (溝通技巧)", full: "Interpersonal & Communication" },
        { subject: "R: Reflection (反思學習)", full: "Practice-based Learning" },
        { subject: "I: Info/Knowledge (醫學知識)", full: "Medical Knowledge" },
        { subject: "P: Professionalism (專業素養)", full: "Professionalism" },
        { subject: "P: Patient Care (病人照護)", full: "Patient Care" },
        { subject: "P: Partners (跨域團隊)", full: "Inter-professional Practice" },
      ];

      // 11 項 EPA 任務（和你原本設定一致）
      const epaScenarios = [
        {
          id: "epa1",
          name: "EPA 1: 提供病人藥物吸入治療照護",
          color: "rgba(59,130,246,1)",
          bg: "rgba(59,130,246,0.2)",
          data: [
            { subject: "S: Systems (制度體系)", A: 40 },
            { subject: "I: Interpersonal (溝通技巧)", A: 60 },
            { subject: "R: Reflection (反思學習)", A: 40 },
            { subject: "I: Info/Knowledge (醫學知識)", A: 80 },
            { subject: "P: Professionalism (專業素養)", A: 70 },
            { subject: "P: Patient Care (病人照護)", A: 85 },
            { subject: "P: Partners (跨域團隊)", A: 40 },
          ],
        },
        {
          id: "epa2",
          name: "EPA 2: 提供病人痰液清除照護",
          color: "rgba(6,182,212,1)",
          bg: "rgba(6,182,212,0.2)",
          data: [
            { subject: "S: Systems (制度體系)", A: 45 },
            { subject: "I: Interpersonal (溝通技巧)", A: 50 },
            { subject: "R: Reflection (反思學習)", A: 40 },
            { subject: "I: Info/Knowledge (醫學知識)", A: 75 },
            { subject: "P: Professionalism (專業素養)", A: 75 },
            { subject: "P: Patient Care (病人照護)", A: 90 },
            { subject: "P: Partners (跨域團隊)", A: 50 },
          ],
        },
        {
          id: "epa3",
          name: "EPA 3: 提供胸腹手術病人肺擴張治療照護",
          color: "rgba(20,184,166,1)",
          bg: "rgba(20,184,166,0.2)",
          data: [
            { subject: "S: Systems (制度體系)", A: 50 },
            { subject: "I: Interpersonal (溝通技巧)", A: 75 },
            { subject: "R: Reflection (反思學習)", A: 50 },
            { subject: "I: Info/Knowledge (醫學知識)", A: 80 },
            { subject: "P: Professionalism (專業素養)", A: 70 },
            { subject: "P: Patient Care (病人照護)", A: 85 },
            { subject: "P: Partners (跨域團隊)", A: 60 },
          ],
        },
        {
          id: "epa4",
          name: "EPA 4: 提供病人呼吸功能改善處置",
          color: "rgba(16,185,129,1)",
          bg: "rgba(16,185,129,0.2)",
          data: [
            { subject: "S: Systems (制度體系)", A: 40 },
            { subject: "I: Interpersonal (溝通技巧)", A: 85 },
            { subject: "R: Reflection (反思學習)", A: 60 },
            { subject: "I: Info/Knowledge (醫學知識)", A: 75 },
            { subject: "P: Professionalism (專業素養)", A: 80 },
            { subject: "P: Patient Care (病人照護)", A: 80 },
            { subject: "P: Partners (跨域團隊)", A: 50 },
          ],
        },
        {
          id: "epa5",
          name: "EPA 5: 提供病人氧氣治療照護",
          color: "rgba(132,204,22,1)",
          bg: "rgba(132,204,22,0.2)",
          data: [
            { subject: "S: Systems (制度體系)", A: 60 },
            { subject: "I: Interpersonal (溝通技巧)", A: 50 },
            { subject: "R: Reflection (反思學習)", A: 40 },
            { subject: "I: Info/Knowledge (醫學知識)", A: 70 },
            { subject: "P: Professionalism (專業素養)", A: 70 },
            { subject: "P: Patient Care (病人照護)", A: 85 },
            { subject: "P: Partners (跨域團隊)", A: 40 },
          ],
        },
        {
          id: "epa6",
          name: "EPA 6: 使用侵襲性呼吸器病人之初始設定及照護",
          color: "rgba(234,179,8,1)",
          bg: "rgba(234,179,8,0.2)",
          data: [
            { subject: "S: Systems (制度體系)", A: 75 },
            { subject: "I: Interpersonal (溝通技巧)", A: 50 },
            { subject: "R: Reflection (反思學習)", A: 80 },
            { subject: "I: Info/Knowledge (醫學知識)", A: 95 },
            { subject: "P: Professionalism (專業素養)", A: 85 },
            { subject: "P: Patient Care (病人照護)", A: 95 },
            { subject: "P: Partners (跨域團隊)", A: 80 },
          ],
        },
        {
          id: "epa7",
          name: "EPA 7: 呼吸窘迫病人之處置",
          color: "rgba(249,115,22,1)",
          bg: "rgba(249,115,22,0.2)",
          data: [
            { subject: "S: Systems (制度體系)", A: 70 },
            { subject: "I: Interpersonal (溝通技巧)", A: 60 },
            { subject: "R: Reflection (反思學習)", A: 70 },
            { subject: "I: Info/Knowledge (醫學知識)", A: 95 },
            { subject: "P: Professionalism (專業素養)", A: 90 },
            { subject: "P: Patient Care (病人照護)", A: 100 },
            { subject: "P: Partners (跨域團隊)", A: 85 },
          ],
        },
        {
          id: "epa8",
          name: "EPA 8: 使用呼吸器病人之緊急處置",
          color: "rgba(239,68,68,1)",
          bg: "rgba(239,68,68,0.2)",
          data: [
            { subject: "S: Systems (制度體系)", A: 80 },
            { subject: "I: Interpersonal (溝通技巧)", A: 70 },
            { subject: "R: Reflection (反思學習)", A: 60 },
            { subject: "I: Info/Knowledge (醫學知識)", A: 95 },
            { subject: "P: Professionalism (專業素養)", A: 90 },
            { subject: "P: Patient Care (病人照護)", A: 100 },
            { subject: "P: Partners (跨域團隊)", A: 90 },
          ],
        },
        {
          id: "epa9",
          name: "EPA 9: 使用呼吸器病人之轉送照護",
          color: "rgba(217,70,239,1)",
          bg: "rgba(217,70,239,0.2)",
          data: [
            { subject: "S: Systems (制度體系)", A: 95 },
            { subject: "I: Interpersonal (溝通技巧)", A: 85 },
            { subject: "R: Reflection (反思學習)", A: 70 },
            { subject: "I: Info/Knowledge (醫學知識)", A: 80 },
            { subject: "P: Professionalism (專業素養)", A: 85 },
            { subject: "P: Patient Care (病人照護)", A: 90 },
            { subject: "P: Partners (跨域團隊)", A: 90 },
          ],
        },
        {
          id: "epa10",
          name: "EPA 10: 使用侵襲性呼吸器病人之脫離照護",
          color: "rgba(139,92,246,1)",
          bg: "rgba(139,92,246,0.2)",
          data: [
            { subject: "S: Systems (制度體系)", A: 70 },
            { subject: "I: Interpersonal (溝通技巧)", A: 80 },
            { subject: "R: Reflection (反思學習)", A: 90 },
            { subject: "I: Info/Knowledge (醫學知識)", A: 95 },
            { subject: "P: Professionalism (專業素養)", A: 85 },
            { subject: "P: Patient Care (病人照護)", A: 90 },
            { subject: "P: Partners (跨域團隊)", A: 95 },
          ],
        },
        {
          id: "epa11",
          name: "EPA 11: 移除病人氣管內管之照護",
          color: "rgba(100,116,139,1)",
          bg: "rgba(100,116,139,0.2)",
          data: [
            { subject: "S: Systems (制度體系)", A: 65 },
            { subject: "I: Interpersonal (溝通技巧)", A: 75 },
            { subject: "R: Reflection (反思學習)", A: 70 },
            { subject: "I: Info/Knowledge (醫學知識)", A: 85 },
            { subject: "P: Professionalism (專業素養)", A: 85 },
            { subject: "P: Patient Care (病人照護)", A: 95 },
            { subject: "P: Partners (跨域團隊)", A: 70 },
          ],
        },
      ];

      // ----------- 初始化畫面與圖表 -------------- //

      const labels = competencies.map((c) => c.subject);

      const ctx = document.getElementById("epaRadarChart").getContext("2d");

      // 建立 Chart.js 雷達圖
      let radarChart = new Chart(ctx, {
        type: "radar",
        data: {
          labels,
          datasets: [],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              min: 0,
              max: 100,
              ticks: { display: false },
              grid: { color: "rgba(148,163,184,0.3)" },
              angleLines: { color: "rgba(148,163,184,0.6)" },
            },
          },
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                font: { size: 11 },
              },
            },
            tooltip: {
              callbacks: {
                label(context) {
                  return `${context.dataset.label}: ${context.formattedValue}`;
                },
              },
            },
          },
        },
      });

      // 建立右側 EPA checkbox 清單
      const epaListEl = document.getElementById("epa-list");
      const selectedCountEl = document.getElementById("selected-count");

      function renderEPACheckboxes() {
        epaListEl.innerHTML = "";
        epaScenarios.forEach((epa) => {
          const wrapper = document.createElement("label");
          wrapper.className =
            "flex items-start gap-2 p-2 rounded-lg border cursor-pointer transition bg-white hover:bg-slate-50";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "mt-1";
          // 預設選 EPA 6
          if (epa.id === "epa6") checkbox.checked = true;

          checkbox.addEventListener("change", updateChartFromSelection);

          const textBox = document.createElement("div");
          textBox.className = "flex-1";

          const title = document.createElement("div");
          title.className = "font-bold text-sm";
          title.style.color = epa.color;
          title.textContent = epa.name.split(":")[0];

          const subtitle = document.createElement("div");
          subtitle.className = "text-xs text-slate-500";
          subtitle.textContent = epa.name.split(":")[1];

          textBox.appendChild(title);
          textBox.appendChild(subtitle);

          wrapper.appendChild(checkbox);
          wrapper.appendChild(textBox);

          epaListEl.appendChild(wrapper);

          // 把 checkbox element 存起來方便之後查
          epa._checkbox = checkbox;
        });
      }

      function updateChartFromSelection() {
        const selected = epaScenarios.filter((epa) => epa._checkbox && epa._checkbox.checked);

        if (selected.length === 0) {
          // 若全沒選，就強迫至少選 EPA 6
          const epa6 = epaScenarios.find((e) => e.id === "epa6");
          if (epa6 && epa6._checkbox) {
            epa6._checkbox.checked = true;
            return updateChartFromSelection();
          }
        }

        const datasets = selected.map((epa) => {
          // 依照 competencies 順序取得數值
          const dataValues = labels.map((label) => {
            const found = epa.data.find((d) => d.subject === label);
            return found ? found.A : 0;
          });
          return {
            label: epa.name,
            data: dataValues,
            borderColor: epa.color,
            backgroundColor: epa.bg,
            borderWidth: 2,
            pointRadius: 2,
          };
        });

        radarChart.data.datasets = datasets;
        radarChart.update();

        selectedCountEl.textContent = `已顯示 ${selected.length} 個 EPA 任務`;
      }

      // 顯示 SIRIPPP 說明
      const siripppListEl = document.getElementById("sirippp-list");
      competencies.forEach((c) => {
        const li = document.createElement("li");
        li.className = "flex gap-2";
        const tag = c.subject.split(":")[0];
        const desc = c.subject.split(":")[1];
        li.innerHTML = `<span class="w-6 text-slate-300">${tag}：</span><span>${desc}</span>`;
        siripppListEl.appendChild(li);
      });

      // 初始化畫面
      renderEPACheckboxes();
      updateChartFromSelection();
    </script>
  </body>
</html>
